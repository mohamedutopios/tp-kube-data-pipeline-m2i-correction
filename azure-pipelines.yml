trigger:
  branches:
    include:
      - main
  paths:
    include:
      - producer/*
      - spark-app/*
      - web/*
      - k8s/*

variables:
  ACR_NAME: "myacrmohamedaprr"
  ACR_LOGIN: "$(ACR_NAME).azurecr.io"
  IMAGE_TAG: "$(Build.BuildId)"
  K8S_NAMESPACE: "bank-pipeline"

  # Azure DevOps Service Connection
  AKS_CONNECTION: "connectionAzure"

  # AKS Cluster
  AKS_RG: "myRG"
  AKS_NAME: "myAKS"

# ==========================================================
#                        CI
# ==========================================================
stages:
- stage: CI
  displayName: "Build + Scan + Push images"
  jobs:

  # ------------------------------------------------------
  # DETECT CHANGES
  # ------------------------------------------------------
  - job: detect_changes
    displayName: "D√©tecter les microservices modifi√©s"

    steps:
      - checkout: self
        persistCredentials: true

      - bash: |
          echo "## D√©tection des changements"

          git diff --quiet HEAD~1 HEAD -- producer || echo "##vso[task.setvariable variable=changed_producer]true"
          git diff --quiet HEAD~1 HEAD -- spark-app || echo "##vso[task.setvariable variable=changed_spark]true"
          git diff --quiet HEAD~1 HEAD -- web || echo "##vso[task.setvariable variable=changed_web]true"

          echo "Producer changed: $(changed_producer)"
          echo "Spark changed:    $(changed_spark)"
          echo "Web changed:      $(changed_web)"
        name: detect

  # ------------------------------------------------------
  # LOGIN AZURE
  # ------------------------------------------------------
  - job: init_azure
    displayName: "Login Azure"
    dependsOn: detect_changes
    pool:
      vmImage: ubuntu-latest

    steps:
      - task: AzureCLI@2
        displayName: "Login Azure SPN"
        inputs:
          azureSubscription: "$(AKS_CONNECTION)"
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            echo "Connexion Azure OK"
            az account show


  # ======================================================
  # BUILD PRODUCER
  # ======================================================
  - job: build_producer
    displayName: "Build Producer image"
    dependsOn:
      - detect_changes
      - init_azure
    condition: eq(variables['changed_producer'], 'true')

    steps:
      - checkout: self

      - task: AzureCLI@2
        displayName: "Login ACR"
        inputs:
          azureSubscription: "$(AKS_CONNECTION)"
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az acr login --name $(ACR_NAME)

      - bash: docker build -t $(ACR_LOGIN)/producer:$(IMAGE_TAG) ./producer
        displayName: "Docker build producer"

      - bash: trivy image --exit-code 1 --severity CRITICAL $(ACR_LOGIN)/producer:$(IMAGE_TAG)
        displayName: "Scan Producer"

      - bash: docker push $(ACR_LOGIN)/producer:$(IMAGE_TAG)
        displayName: "Push Producer"

      - bash: |
          sed -i "s|image: .*producer:.*|image: $(ACR_LOGIN)/producer:$(IMAGE_TAG)|" k8s/apps-producer.yaml
        displayName: "Update manifest producer"

      - publish: k8s/apps-producer.yaml
        artifact: producer-manifest


  # ======================================================
  # BUILD SPARK
  # ======================================================
  - job: build_spark
    displayName: "Build Spark image"
    dependsOn:
      - detect_changes
      - init_azure
    condition: eq(variables['changed_spark'], 'true')

    steps:
      - checkout: self

      - task: AzureCLI@2
        displayName: "Login ACR"
        inputs:
          azureSubscription: "$(AKS_CONNECTION)"
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az acr login --name $(ACR_NAME)

      - bash: docker build -t $(ACR_LOGIN)/spark-app:$(IMAGE_TAG) ./spark-app
        displayName: "Docker build spark"

      - bash: trivy image --exit-code 1 --severity CRITICAL $(ACR_LOGIN)/spark-app:$(IMAGE_TAG)
        displayName: "Scan Spark"

      - bash: docker push $(ACR_LOGIN)/spark-app:$(IMAGE_TAG)
        displayName: "Push Spark"

      - bash: |
          sed -i "s|image: .*spark-app:.*|image: $(ACR_LOGIN)/spark-app:$(IMAGE_TAG)|" k8s/apps-spark.yaml
        displayName: "Update manifest spark"

      - publish: k8s/apps-spark.yaml
        artifact: spark-manifest


  # ======================================================
  # BUILD WEB
  # ======================================================
  - job: build_web
    displayName: "Build Web image"
    dependsOn:
      - detect_changes
      - init_azure
    condition: eq(variables['changed_web'], 'true')

    steps:
      - checkout: self

      - task: AzureCLI@2
        displayName: "Login ACR"
        inputs:
          azureSubscription: "$(AKS_CONNECTION)"
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az acr login --name $(ACR_NAME)

      - bash: docker build -t $(ACR_LOGIN)/web:$(IMAGE_TAG) ./web
        displayName: "Docker build web"

      - bash: trivy image --exit-code 1 --severity CRITICAL $(ACR_LOGIN)/web:$(IMAGE_TAG)
        displayName: "Scan Web"

      - bash: docker push $(ACR_LOGIN)/web:$(IMAGE_TAG)
        displayName: "Push Web"

      - bash: |
          sed -i "s|image: .*web:.*|image: $(ACR_LOGIN)/web:$(IMAGE_TAG)|" k8s/apps-web.yaml
        displayName: "Update manifest web"

      - publish: k8s/apps-web.yaml
        artifact: web-manifest


# ==========================================================
#                        CD ‚Äì DEPLOYMENT AKS
# ==========================================================
- stage: CD
  displayName: "D√©ploiement AKS"
  dependsOn: CI

  jobs:
    - deployment: deploy_k8s
      displayName: "Apply manifests mis √† jour"
      environment: "aks-env"

      strategy:
        runOnce:
          deploy:
            steps:

              # üî• IMPORTANT ‚Äì pour que k8s/ soit pr√©sent
              - checkout: self

              # ---------------------------------------
              # Connexion AKS
              # ---------------------------------------
              - task: AzureCLI@2
                displayName: "Connexion AKS"
                inputs:
                  azureSubscription: "$(AKS_CONNECTION)"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az aks get-credentials \
                      --resource-group $(AKS_RG) \
                      --name $(AKS_NAME) \
                      --overwrite-existing

              # ---------------------------------------
              # T√©l√©charger les manifests modifi√©s
              # ---------------------------------------
              - download: current
                artifact: producer-manifest
                condition: eq(variables['changed_producer'], 'true')

              - download: current
                artifact: spark-manifest
                condition: eq(variables['changed_spark'], 'true')

              - download: current
                artifact: web-manifest
                condition: eq(variables['changed_web'], 'true')

              # ---------------------------------------
              # DEPLOIEMENT INITIAL (corrig√©)
              # ---------------------------------------
              - bash: |
                  echo "=== Checking if initial deploy is needed ==="

                  if ! kubectl get ns $(K8S_NAMESPACE); then
                    echo ">>> Creating namespace"
                    kubectl apply -f k8s/namespace.yaml
                    sleep 3
                  fi

                  if ! kubectl get deployment producer -n $(K8S_NAMESPACE); then
                    echo ">>> Initial deployment: applying all manifests EXCEPT namespace"
                    find k8s/ -type f ! -name "namespace.yaml" -exec kubectl apply -f {} \;
                  else
                    echo ">>> Initial deployment already done."
                  fi
                displayName: "Initial deploy if needed"

              # ---------------------------------------
              # Apply des manifests modifi√©s
              # ---------------------------------------
              - bash: |
                  echo "=== Applying updated manifests ==="
                  find $(Pipeline.Workspace) -name "*.yaml" -exec kubectl apply -n $(K8S_NAMESPACE) -f {} \;
                displayName: "kubectl apply"

              # ---------------------------------------
              # Restart safe
              # ---------------------------------------
              - bash: |
                  kubectl rollout restart deployment/producer -n $(K8S_NAMESPACE) || true
                  kubectl rollout restart deployment/spark-app -n $(K8S_NAMESPACE) || true
                  kubectl rollout restart deployment/web -n $(K8S_NAMESPACE) || true
                displayName: "Restart deployments"
